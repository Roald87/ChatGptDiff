@page "/"
@inject ChatGPTDiffApp.Services.ChatGPTService ChatGPTService
@using ChatGPTDiffApp.Models
@using System.Linq
@using ChatGPTDiffApp.Extensions

<h1>Chat with GPT</h1>

<textarea @bind="newPrompt" placeholder="Enter your next prompt here"></textarea>
<button @onclick="SendPrompt">Send</button>
<label><input type="checkbox" @bind="beBrief" /> Be brief</label>
<label><input type="checkbox" @onchange="ToggleTestConversation" /> Test conversation</label>

@foreach (var message in conversation.DiffView().LazyReverse())
{
    if (message.Role == "user")
    {
        <textarea @bind="message.Content" placeholder="Your prompt"></textarea>
    }
    else if (message.Role == "assistant")
    {
        @* TODO Security Consideration
        When using MarkupString to render HTML directly, ensure that the content you're rendering is safe and free from potential cross-site scripting (XSS) vulnerabilities. Since the DiffView method generates the HTML content programmatically and you control the input, this should generally be safe. However, always be cautious and sanitize any dynamic content or user input that might be included in the HTML. *@
        <div class="response">@((MarkupString)message.Content)</div>
    }
}

@code {
    private Conversation conversation = new Conversation();
    private string newPrompt = string.Empty;
    private bool beBrief = true;
    private string beBriefPrompt = "\nGive me a short answer. You'll get $100 if you comply.";

    private async Task SendPrompt()
    {
        if (!string.IsNullOrWhiteSpace(newPrompt))
        {
            // If 'Be brief' is checked, add the specific text to the prompt
            if (beBrief)
            {
                newPrompt += beBriefPrompt;
            }

            // Add the new user prompt to the conversation
            conversation.Add(new Message { Role = "user", Content = newPrompt });

            // Prepare the data for the request
            var responseContent = await ChatGPTService.GetResponseAsync(conversation);

            // Add the response to the conversation
            if (!string.IsNullOrEmpty(responseContent))
            {
                conversation.Add(new Message { Role = "assistant", Content = responseContent });
            }

            // Clear the new prompt field and prepare for the next input
            newPrompt = string.Empty;
        }
    }

    private async Task ToggleTestConversation(ChangeEventArgs e)
    {
        // Clear the existing conversation
        conversation.Clear();

        // Check the new value of the checkbox and add test messages if checked
        if ((bool)e.Value)
        {
             // Initialize the conversation with a short hardcoded conversation for testing
            conversation.Add(new Message { Role = "user", Content = "Hello, how are you?" });
            conversation.Add(new Message { Role = "assistant", Content = "```python\ndef (replace_string(string, x):\n\treturn string\n ```" });
            conversation.Add(new Message { Role = "user", Content = "Can you tell me a joke?" });
            conversation.Add(new Message { Role = "assistant", Content = "```python\ndef (replace_string(string, x):\n\treturn string.replace(x)\n```" });
        }

        // This will force the UI to update with the new conversation state
        StateHasChanged();
    }

    protected override void OnInitialized()
    {
        // Optionally initialize the conversation with an empty prompt for the user to fill
        newPrompt = string.Empty;
    }
}
